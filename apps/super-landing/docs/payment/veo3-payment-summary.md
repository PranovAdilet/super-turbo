# VEO3 Payment Flow - –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞

### –î–æ –æ–ø–ª–∞—Ç—ã:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É** ‚Üí –ø—Ä–æ–º–ø—Ç + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ
2. **–°–æ–∑–¥–∞–µ—Ç—Å—è Stripe —Å–µ—Å—Å–∏—è** ‚Üí –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Redis
3. **–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Stripe** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç

### –í–æ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã:

4. **Stripe webhook** ‚Üí `checkout.session.completed`
5. **Backend –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ** –∏–∑ Redis
6. **–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** —á–µ—Ä–µ–∑ SuperDuperAI API
7. **–ü–æ–ª—É—á–∞–µ—Ç—Å—è fileId** –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Redis

### –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:

8. **Success page** ‚Üí polling —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
9. **–ê–≤—Ç–æ—Ä–µ–¥–∏—Ä–µ–∫—Ç** –Ω–∞ `/file/{fileId}` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ fileId
10. **File status page** ‚Üí polling –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
11. **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ** –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ

## üìÅ –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª                                                | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ             |
| --------------------------------------------------- | ---------------------- |
| `src/app/api/create-checkout/route.ts`              | –°–æ–∑–¥–∞–Ω–∏–µ Stripe —Å–µ—Å—Å–∏–∏ |
| `src/app/api/webhooks/stripe/route.ts`              | –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤   |
| `src/app/api/webhook-status/[sessionId]/route.ts`   | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞       |
| `src/app/api/file/[id]/route.ts`                    | –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞        |
| `src/components/payment/payment-success-client.tsx` | Success page           |
| `src/components/file/file-status-client.tsx`        | File status page       |

## üîÑ URL Flow

```
1. /tool/veo3-prompt-generator (—Ñ–æ—Ä–º–∞)
2. https://checkout.stripe.com/pay/cs_xxx (–æ–ø–ª–∞—Ç–∞)
3. /payment-success/cs_xxx (success page)
4. /file/{fileId} (—Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–∞)
```

## ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏

| –≠—Ç–∞–ø              | –í—Ä–µ–º—è       |
| ----------------- | ----------- |
| –û–ø–ª–∞—Ç–∞            | 10-30 —Å–µ–∫   |
| Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ | 5-15 —Å–µ–∫    |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ   | 2-5 –º–∏–Ω     |
| **–û–±—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å** | **3-6 –º–∏–Ω** |

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **Stripe signature verification** –¥–ª—è webhook'–æ–≤
- **UUID validation** –¥–ª—è fileId
- **Session ID format** –ø—Ä–æ–≤–µ—Ä–∫–∞ (cs_xxx)
- **–¢–∞–π–º–∞—É—Ç—ã** –Ω–∞ –≤—Å–µ API –≤—ã–∑–æ–≤—ã

## üîß Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã

- **Polling** –µ—Å–ª–∏ webhook –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω
- **–†—É—á–Ω–æ–π –ø–æ–∏—Å–∫** –ø–æ sessionId: `/session/{sessionId}`
- **Dev —Ä–µ–∂–∏–º** –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤: `/dev/files`
- **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ sessionId** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

## üìä –°—Ç–∞—Ç—É—Å—ã

### Redis —Å—Ç–∞—Ç—É—Å—ã:

- `pending` ‚Üí `processing` ‚Üí `completed`/`error`

### SuperDuperAI —Å—Ç–∞—Ç—É—Å—ã:

- `pending` ‚Üí `in_progress` ‚Üí `completed`/`failed`

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏

1. **Webhook timeout**: 15 —Å–µ–∫—É–Ω–¥
2. **UI polling timeout**: 60 —Å–µ–∫—É–Ω–¥
3. **Video generation**: –¥–æ 10 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º
4. **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** ‚Üí –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏:

```bash
grep "Stripe webhook event" logs
grep "SuperDuperAI video generation" logs
grep "‚ùå" logs
```

### Redis:

```bash
redis-cli get "session:cs_xxx"
```

### SuperDuperAI:

```bash
curl -H "Authorization: Bearer $TOKEN" \
  "https://api.superduperai.com/api/v1/file/{fileId}"
```

## üí° –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ Redis** - –Ω–µ –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ Stripe metadata
2. **Polling –∫–∞–∫ fallback** - –µ—Å–ª–∏ webhook –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã** - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
5. **Graceful degradation** - fallback –æ–ø—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
