# Семантический поиск изображений

## Обзор

Система семантического поиска изображений позволяет пользователям находить изображения из истории чата по описанию их содержимого, а не только по явным ссылкам или порядковым номерам.

## Возможности

### Поддерживаемые запросы

#### Русские запросы:

- "возьми картинку с луной"
- "изображение с самолетом"
- "фото с девочкой"
- "картинка с собакой"
- "изображение с машиной"
- "фото с домом"
- "картинка с лесом"
- "изображение с морем"
- "картинка где есть лес"

#### Английские запросы:

- "image with moon"
- "picture with airplane"
- "photo with girl"
- "image with dog"
- "picture with car"
- "photo with house"
- "image with forest"
- "picture with sea"
- "image that has trees"

### Категории поиска

Система поддерживает поиск по следующим категориям:

#### Природа

- Луна, солнце, звезды, небо, облака
- Дождь, снег, лес, море, горы, река, озеро

#### Животные

- Собака, кошка, птица, рыба, лошадь, корова, свинья

#### Люди

- Девочка, мальчик, ребенок, семья

#### Транспорт

- Машина, самолет, поезд, велосипед, мотоцикл, корабль

#### Здания

- Дом, замок, церковь, школа, больница

#### Еда

- Пицца, торт, фрукты, овощи

#### Цвета

- Красный, синий, зеленый, желтый, черный, белый

#### Эмоции и состояния

- Счастливый, грустный, злой, усталый

## Как это работает

### 1. Анализ сообщения

Система анализирует сообщение пользователя и извлекает ключевые слова, связанные с содержимым изображений.

### 2. Поиск по промптам и именам файлов

Система ищет изображения, в промптах или именах файлов которых содержатся извлеченные ключевые слова.

### 3. Ранжирование результатов

Найденные изображения ранжируются по релевантности, и возвращается наиболее подходящее.

### 4. Логирование

Все этапы поиска логируются для отладки и мониторинга.

## Примеры использования

### Сценарий 1: Поиск изображения с луной

```
Пользователь: "возьми картинку с луной"
Система: Находит изображение с промптом "Beautiful landscape with mountains and a lake under the moonlight"
Результат: Возвращает URL изображения с луной
```

### Сценарий 2: Поиск изображения с девочкой

```
Пользователь: "картинка с девочкой"
Система: Находит изображение с промптом "A girl with blue eyes and long hair standing in a forest"
Результат: Возвращает URL изображения с девочкой
```

### Сценарий 3: Универсальный поиск

```
Пользователь: "картинка где есть лес"
Система: Извлекает ключевые слова ["лес", "forest", "деревья", "trees", "природа", "nature"]
Система: Находит изображение с промптом "A girl with blue eyes and long hair standing in a forest"
Результат: Возвращает URL изображения с лесом
```

### Сценарий 4: Поиск по имени файла

```
Пользователь: "use photo with moon and animate"
Система: Извлекает ключевые слова ["луна", "moon", "лунный", "lunar", "ночной", "nocturnal", "ночь", "night"]
Система: Находит изображение с именем файла "nochnoj_gorod_ulitsa_ogni_goroda_134353_1366x768.jpg"
Результат: Возвращает URL ночного городского изображения (которое может содержать луну)
```

### Сценарий 5: Fallback при неудачном поиске

```
Пользователь: "use photo with moon and animate"
Система: Извлекает ключевые слова ["луна", "moon", "лунный", "lunar", "ночной", "nocturnal", "ночь", "night"]
Система: Не находит изображений с подходящим содержимым
Система: Использует fallback (последнее изображение)
Система: Обнаруживает, что это fallback для семантического запроса
Результат: Показывает информативное сообщение с предложениями вместо ошибки о балансе
```

## Техническая реализация

### Файлы

- `apps/super-chatbot/src/lib/ai/context/image-context-analyzer.ts` - Основной анализатор
- `apps/super-chatbot/src/lib/ai/chat/image-context.ts` - Совместимость со старой системой
- `apps/super-chatbot/src/lib/ai/context/semantic-search-test.ts` - Тесты

### Ключевые методы

- `findImageByContent()` - Поиск по ключевым словам
- `findImageByUniversalContent()` - Универсальный поиск
- `extractKeywordsFromMessage()` - Извлечение ключевых слов
- `isSemanticPattern()` - Проверка семантических паттернов

### Конфигурация

Система использует словарь ключевых слов (`keywordMap`) для сопоставления пользовательских запросов с содержимым изображений.

## Ограничения

1. **Зависимость от промптов и имен файлов**: Поиск работает по промптам изображений и именам файлов, а не по анализу самих изображений
2. **Языковая поддержка**: Поддерживаются русский и английский языки
3. **Точность**: Точность поиска зависит от качества и детализации промптов изображений и описательности имен файлов
4. **Fallback поведение**: Если семантический поиск не находит подходящее изображение, система показывает информативное сообщение вместо ошибки о недостаточном балансе

## Планы развития

1. **Анализ изображений**: Интеграция с AI для анализа содержимого самих изображений
2. **Расширение словаря**: Добавление новых категорий и ключевых слов
3. **Машинное обучение**: Использование ML для улучшения точности поиска
4. **Многоязычность**: Поддержка дополнительных языков

## Тестирование

Для тестирования семантического поиска используйте:

```typescript
import { testSemanticSearch } from "./semantic-search-test";

// Запуск тестов
testSemanticSearch();
```

Тесты проверяют основные сценарии поиска и возвращают статистику успешности.
