# Smart Image Context Understanding

**Date**: 2025-01-27  
**Type**: Feature Enhancement  
**Status**: ✅ Implemented

## Overview

Система теперь автоматически анализирует контекст чата для определения того, к какому изображению обращается пользователь при запросах на редактирование или модификацию.

## Problem Solved

Ранее система всегда использовала одно и то же изображение для image-to-image генерации, независимо от контекста запроса пользователя. Это приводило к тому, что:

- Пользователь не мог ссылаться на конкретные изображения
- Система не понимала контекст "это изображение", "последнее фото" и т.д.
- Всегда использовалось последнее загруженное изображение

## Solution Implemented

### 1. Intelligent Context Analysis

Система теперь анализирует:

- **Текущее сообщение** - наличие изображений в attachments
- **Историю чата** - все изображения, сгенерированные или загруженные
- **Текст запроса** - ключевые слова и ссылки на изображения

### 2. Smart Image Selection

#### Explicit References (Высокая точность)

- **"это изображение"** → последнее изображение в чате
- **"первое фото"** → первое изображение по порядку
- **"то что ты сгенерировал"** → последнее сгенерированное изображение
- **"загруженное фото"** → последнее загруженное пользователем

#### Implicit Context (Средняя точность)

- **"сделай глаза голубыми"** → последнее изображение (контекст редактирования)
- **"измени цвет"** → последнее изображение (контекст стиля)
- **"подправь фон"** → последнее изображение (контекст улучшения)

#### Fallback (Низкая точность)

- Если контекст неясен → используется последнее изображение в чате

### 3. Multi-language Support

Система понимает ссылки на изображения на русском и английском языках:

**Русский:**

- "это изображение", "последнее фото", "первая картинка"
- "сгенерированное изображение", "загруженное фото"
- "на этом изображении", "в этой картинке"

**English:**

- "this image", "last photo", "first picture"
- "generated image", "uploaded photo"
- "on this image", "in this picture"

## Technical Implementation

### Core Files

- `src/lib/ai/chat/image-context.ts` - основная логика анализа контекста
- `src/app/(chat)/api/chat/route.ts` - интеграция в API чата
- `src/lib/ai/prompts.ts` - обновленные инструкции для AI

### Key Functions

```typescript
// Анализ контекста изображения
analyzeImageContext(
  userMessage: string,
  chatHistory: DBMessage[],
  currentMessageAttachments?: any[]
): Promise<ImageContext>

// Получение изображений из истории чата
getChatImages(chatId: string): Promise<ChatImage[]>
```

### Context Analysis Flow

1. **Check Current Message** → изображения в текущем сообщении
2. **Extract Chat History** → все изображения из истории
3. **Pattern Matching** → поиск явных ссылок по ключевым словам
4. **Heuristic Analysis** → анализ контекста по эвристикам
5. **Fallback Selection** → выбор последнего изображения

## Usage Examples

### Example 1: Explicit Reference

```
User: "Измени первое изображение, сделай его черно-белым"
System: ✅ Найдена ссылка на изображение: первое изображение
Result: Используется cat1.jpg (первое изображение в чате)
```

### Example 2: Implicit Context

```
User: "Сделай глаза голубыми"
System: ✅ Изображение выбрано по эвристике: контекст редактирования
Result: Используется dog1.jpg (последнее изображение)
```

### Example 3: Current Message

```
User: [загружает фото] "Подправь это изображение"
System: ✅ Изображение найдено в текущем сообщении пользователя
Result: Используется загруженное изображение
```

### Example 4: Fallback

```
User: "Улучши качество"
System: ⚠️ Используется последнее изображение из чата
Result: Используется dog1.jpg (последнее доступное)
```

## Confidence Levels

- **High (0.9-1.0)**: Изображение в текущем сообщении
- **Medium (0.6-0.8)**: Найдена явная ссылка или эвристика
- **Low (0.0-0.5)**: Fallback к последнему изображению

## Benefits

1. **Natural Conversation** - пользователь может естественно ссылаться на изображения
2. **Context Awareness** - система понимает контекст запроса
3. **Multi-language** - поддержка русского и английского языков
4. **Fallback Safety** - всегда есть изображение для работы
5. **Transparency** - система объясняет, почему выбрано то или иное изображение

## Testing

Создан тестовый файл `image-context.test.ts` с покрытием основных сценариев:

- Поиск изображения в текущем сообщении
- Анализ контекста по эвристикам
- Обработка явных ссылок
- Fallback логика
- Поддержка русского и английского языков

## Future Enhancements

1. **Visual Similarity** - поиск изображений по визуальному сходству
2. **Semantic Analysis** - понимание содержания изображений
3. **User Preferences** - запоминание предпочтений пользователя
4. **Batch Operations** - работа с несколькими изображениями одновременно

## Migration Notes

- ✅ Обратная совместимость сохранена
- ✅ Fallback к старой логике при ошибках
- ✅ Логирование для отладки
- ✅ Graceful degradation при проблемах с БД
