# Инструкция по применению миграции для гостевых сессий

## Описание изменений

Добавлено поле `sessionId` в таблицу `User` для связывания гостевых аккаунтов с уникальными идентификаторами сессий.

## Файлы миграции

- `src/lib/db/migrations/0001_add_session_id.sql` - SQL миграция
- `src/lib/db/schema.ts` - обновленная схема
- `src/lib/session-utils.ts` - утилиты для работы с сессиями
- `src/app/(auth)/auth.ts` - обновленная логика NextAuth
- `src/app/(auth)/api/auth/guest/route.ts` - обновленный API endpoint

## Применение миграции

### 1. Выполните SQL миграцию в базе данных:

```sql
-- Добавить поле sessionId в таблицу User
ALTER TABLE "User" ADD COLUMN "sessionId" varchar(64);

-- Создать индекс для быстрого поиска
CREATE INDEX IF NOT EXISTS "User_sessionId_idx" ON "User"("sessionId");

-- Добавить уникальное ограничение
CREATE UNIQUE INDEX IF NOT EXISTS "User_sessionId_unique_idx" ON "User"("sessionId") WHERE "sessionId" IS NOT NULL;
```

### 2. Перезапустите приложение

После применения миграции перезапустите приложение для применения изменений.

## Как это работает

### До миграции:

- Каждый вход в гостевой режим создавал новый аккаунт
- При очистке куки сессия терялась навсегда

### После миграции:

- Гостевые аккаунты связываются с уникальным `sessionId`
- `sessionId` сохраняется в localStorage как fallback
- Даже при очистке куки система может восстановить гостевую сессию
- В базе данных не накапливаются лишние гостевые аккаунты

## Тестирование

1. Войдите в гостевой режим
2. Создайте чат
3. Очистите куки браузера
4. Перезагрузите страницу
5. Войдите снова в гостевой режим
6. Проверьте, что ваш чат восстановился

## Откат изменений

Если нужно откатить изменения:

```sql
-- Удалить индексы
DROP INDEX IF EXISTS "User_sessionId_idx";
DROP INDEX IF EXISTS "User_sessionId_unique_idx";

-- Удалить поле
ALTER TABLE "User" DROP COLUMN "sessionId";
```

## Примечания

- Поле `sessionId` может быть `NULL` для существующих пользователей
- Новые гостевые пользователи будут автоматически получать `sessionId`
- Система обратно совместима с существующими данными


