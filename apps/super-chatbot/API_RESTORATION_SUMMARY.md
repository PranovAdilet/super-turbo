# üîß –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ API —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ Prefect

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ API

- **–§–∞–π–ª**: `src/app/api/story-editor/generate/route.ts`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è `createUserProject`, `updateProjectStatus`, `handlePrefectError`
  - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å —Å—Ç–∞—Ç—É—Å–æ–º `pending`
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ `processing`
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –æ—Ç–∫–∞—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### 2. –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

```typescript
// 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤ SuperDuperAI
const result = await ProjectService.projectVideo({ requestBody: payload });

// 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"
await createUserProject(userId, projectId, creditsUsed);

// 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "processing"
await updateProjectStatus(projectId, "processing");

// 4. –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
await deductOperationBalance(
  userId,
  "story-editor",
  "project-video",
  qualityMultipliers,
  metadata
);

// 5. –ü—Ä–∏ –æ—à–∏–±–∫–µ - –æ—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ handlePrefectError
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Prefect

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Prefect –ø–∞–π–ø–ª–∞–π–Ω–∞
- **–í–æ–∑–≤—Ä–∞—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞** –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ `failed`
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –æ—à–∏–±–æ–∫

## ‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

- **–§–∞–π–ª**: `src/lib/db/migrations/0011_add_project_status.sql`
- **–ö–æ–ª–æ–Ω–∫–∏**: `status`, `creditsUsed`, `errorMessage`, `updatedAt`
- **–ò–Ω–¥–µ–∫—Å—ã**: –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **–ü—Ä–æ–µ–∫—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
2. **–ë–∞–ª–∞–Ω—Å —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è** —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
3. **–û—à–∏–±–∫–∏ Prefect –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è** —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –∫—Ä–µ–¥–∏—Ç–æ–≤
4. **–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–æ–≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
5. **API –≥–æ—Ç–æ–≤** –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Prefect –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é** (—Å–º. `MIGRATION_APPLY_NOW.md`)
2. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
4. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å** —Å Prefect –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

---

**API –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! üöÄ**


